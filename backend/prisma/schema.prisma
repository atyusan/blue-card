generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String       @id @default(cuid())
  email       String       @unique
  username    String?      @unique
  password    String
  firstName   String
  lastName    String
  role        UserRole
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  auditLogs   AuditLog[]
  patient     Patient?
  staffMember StaffMember?

  @@map("users")
}

model StaffMember {
  id                        String            @id @default(cuid())
  userId                    String            @unique
  employeeId                String            @unique
  department                String
  specialization            String?
  licenseNumber             String?
  hireDate                  DateTime
  isActive                  Boolean           @default(true)
  createdAt                 DateTime          @default(now())
  updatedAt                 DateTime          @updatedAt
  admissions                Admission[]
  cashTransactions          CashTransaction[]
  consultations             Consultation[]
  labOrders                 LabOrder[]
  pettyCashApprovals        PettyCash[]       @relation("PettyCashApprover")
  pettyCashRequests         PettyCash[]       @relation("PettyCashRequester")
  prescriptions             Prescription[]
  user                      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  anesthesiologistSurgeries Surgery[]         @relation("Anesthesiologist")
  surgeries                 Surgery[]

  // Cash Request Relations
  cashRequestRequests   CashRequest[] @relation("CashRequestRequester")
  cashRequestApprovals  CashRequest[] @relation("CashRequestApprover")
  cashRequestRejections CashRequest[] @relation("CashRequestRejector")

  @@map("staff_members")
}

model Patient {
  id                           String            @id @default(cuid())
  patientId                    String            @unique
  firstName                    String
  lastName                     String
  dateOfBirth                  DateTime
  gender                       Gender
  phoneNumber                  String?
  email                        String?
  address                      String?
  allergies                    String?
  isActive                     Boolean           @default(true)
  createdAt                    DateTime          @default(now())
  updatedAt                    DateTime          @updatedAt
  bloodGroup                   BloodType?
  emergencyContactName         String?
  emergencyContactPhone        String?
  emergencyContactRelationship String?
  genotype                     Genotype?
  height                       String?
  insuranceProvider            String?
  insurancePolicyNumber        String?
  insuranceGroupNumber         String?
  userId                       String?           @unique
  admissions                   Admission[]
  cashTransactions             CashTransaction[]
  consultations                Consultation[]
  invoices                     Invoice[]
  labOrders                    LabOrder[]
  account                      PatientAccount?
  user                         User?             @relation(fields: [userId], references: [id])
  payments                     Payment[]
  paystackCustomer             PaystackCustomer?
  prescriptions                Prescription[]
  refunds                      Refund[]
  surgeries                    Surgery[]

  @@map("patients")
}

model PatientAccount {
  id            String   @id @default(cuid())
  patientId     String   @unique
  accountNumber String   @unique
  balance       Decimal  @default(0) @db.Decimal(10, 2)
  creditLimit   Decimal? @db.Decimal(10, 2)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  patient       Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("patient_accounts")
}

model ServiceCategory {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  services    Service[]

  @@map("service_categories")
}

model Service {
  id                 String          @id @default(cuid())
  name               String
  description        String?
  categoryId         String
  basePrice          Decimal         @db.Decimal(10, 2)
  currentPrice       Decimal         @db.Decimal(10, 2)
  serviceCode        String?
  isActive           Boolean         @default(true)
  requiresPrePayment Boolean         @default(false)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  charges            Charge[]
  dailyCharges       DailyCharge[]
  labTests           LabTest[]
  category           ServiceCategory @relation(fields: [categoryId], references: [id])

  @@map("services")
}

model Invoice {
  id                String           @id @default(cuid())
  invoiceNumber     String           @unique
  patientId         String
  totalAmount       Decimal          @db.Decimal(10, 2)
  paidAmount        Decimal          @default(0) @db.Decimal(10, 2)
  balance           Decimal          @db.Decimal(10, 2)
  status            InvoiceStatus    @default(PENDING)
  dueDate           DateTime?
  issuedDate        DateTime         @default(now())
  paidDate          DateTime?
  notes             String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  paystackInvoiceId String?
  paystackReference String?
  charges           Charge[]
  patient           Patient          @relation(fields: [patientId], references: [id])
  payments          Payment[]
  paystackInvoice   PaystackInvoice?
  refunds           Refund[]

  @@map("invoices")
}

model Charge {
  id          String   @id @default(cuid())
  invoiceId   String
  serviceId   String
  description String
  quantity    Int      @default(1)
  unitPrice   Decimal  @db.Decimal(10, 2)
  totalPrice  Decimal  @db.Decimal(10, 2)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  service     Service  @relation(fields: [serviceId], references: [id])

  @@map("charges")
}

model Payment {
  id          String        @id @default(cuid())
  invoiceId   String
  patientId   String
  amount      Decimal       @db.Decimal(10, 2)
  method      PaymentMethod
  reference   String?
  status      PaymentStatus @default(PENDING)
  processedBy String
  processedAt DateTime      @default(now())
  notes       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  invoice     Invoice       @relation(fields: [invoiceId], references: [id])
  patient     Patient       @relation(fields: [patientId], references: [id])
  refunds     Refund[]

  @@map("payments")
}

model Consultation {
  id               String           @id @default(cuid())
  patientId        String
  doctorId         String
  appointmentDate  DateTime
  consultationType ConsultationType
  diagnosis        String?
  treatment        String?
  notes            String?
  isCompleted      Boolean          @default(false)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  balance          Decimal          @default(0) @db.Decimal(10, 2)
  consultationFee  Decimal          @default(0) @db.Decimal(10, 2)
  isPaid           Boolean          @default(false)
  paidAmount       Decimal          @default(0) @db.Decimal(10, 2)
  totalAmount      Decimal          @default(0) @db.Decimal(10, 2)
  doctor           StaffMember      @relation(fields: [doctorId], references: [id])
  patient          Patient          @relation(fields: [patientId], references: [id])

  @@map("consultations")
}

model LabOrder {
  id          String         @id @default(cuid())
  patientId   String
  doctorId    String
  orderDate   DateTime       @default(now())
  status      LabOrderStatus @default(PENDING)
  isPaid      Boolean        @default(false)
  notes       String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  balance     Decimal        @default(0) @db.Decimal(10, 2)
  paidAmount  Decimal        @default(0) @db.Decimal(10, 2)
  totalAmount Decimal        @default(0) @db.Decimal(10, 2)
  doctor      StaffMember    @relation(fields: [doctorId], references: [id])
  patient     Patient        @relation(fields: [patientId], references: [id])
  tests       LabTest[]

  @@map("lab_orders")
}

model LabTest {
  id         String        @id @default(cuid())
  orderId    String
  serviceId  String
  result     String?
  status     LabTestStatus @default(PENDING)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  isPaid     Boolean       @default(false)
  notes      String?
  totalPrice Decimal       @db.Decimal(10, 2)
  unitPrice  Decimal       @db.Decimal(10, 2)
  order      LabOrder      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  service    Service       @relation(fields: [serviceId], references: [id])

  @@map("lab_tests")
}

model Prescription {
  id               String                   @id @default(cuid())
  patientId        String
  doctorId         String
  prescriptionDate DateTime                 @default(now())
  status           PrescriptionStatus       @default(PENDING)
  isPaid           Boolean                  @default(false)
  notes            String?
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt
  balance          Decimal                  @default(0) @db.Decimal(10, 2)
  paidAmount       Decimal                  @default(0) @db.Decimal(10, 2)
  totalAmount      Decimal                  @default(0) @db.Decimal(10, 2)
  medications      PrescriptionMedication[]
  doctor           StaffMember              @relation(fields: [doctorId], references: [id])
  patient          Patient                  @relation(fields: [patientId], references: [id])

  @@map("prescriptions")
}

model PrescriptionMedication {
  id             String                @id @default(cuid())
  prescriptionId String
  dosage         String
  frequency      String
  duration       String
  instructions   String?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  isPaid         Boolean               @default(false)
  medicationId   String
  quantity       Int
  totalPrice     Decimal               @db.Decimal(10, 2)
  unitPrice      Decimal               @db.Decimal(10, 2)
  dispensedItems DispensedMedication[]
  medication     Medication            @relation(fields: [medicationId], references: [id])
  prescription   Prescription          @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)

  @@map("prescription_medications")
}

model Medication {
  id                   String                   @id @default(cuid())
  name                 String
  genericName          String?
  strength             String?
  form                 String?
  manufacturer         String?
  isActive             Boolean                  @default(true)
  createdAt            DateTime                 @default(now())
  updatedAt            DateTime                 @updatedAt
  category             String?
  controlledDrug       Boolean                  @default(false)
  drugCode             String                   @unique
  requiresPrescription Boolean                  @default(true)
  inventoryItems       MedicationInventory[]
  prescriptionItems    PrescriptionMedication[]

  @@map("medications")
}

model MedicationInventory {
  id                String                @id @default(cuid())
  medicationId      String
  batchNumber       String                @unique
  expiryDate        DateTime
  quantity          Int
  availableQuantity Int
  reservedQuantity  Int                   @default(0)
  unitCost          Decimal               @db.Decimal(10, 4)
  sellingPrice      Decimal               @db.Decimal(10, 2)
  supplier          String?
  purchaseDate      DateTime              @default(now())
  isActive          Boolean               @default(true)
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  dispensedItems    DispensedMedication[]
  medication        Medication            @relation(fields: [medicationId], references: [id])

  @@map("medication_inventory")
}

model DispensedMedication {
  id                       String                 @id @default(cuid())
  prescriptionMedicationId String
  inventoryItemId          String
  quantity                 Int
  dispensedBy              String
  dispensedAt              DateTime               @default(now())
  batchNumber              String
  expiryDate               DateTime
  notes                    String?
  createdAt                DateTime               @default(now())
  updatedAt                DateTime               @updatedAt
  inventoryItem            MedicationInventory    @relation(fields: [inventoryItemId], references: [id])
  prescriptionMedication   PrescriptionMedication @relation(fields: [prescriptionMedicationId], references: [id])

  @@map("dispensed_medications")
}

model Admission {
  id            String          @id @default(cuid())
  patientId     String
  doctorId      String
  admissionDate DateTime        @default(now())
  dischargeDate DateTime?
  wardType      WardType
  bedNumber     String?
  status        AdmissionStatus @default(ADMITTED)
  depositAmount Decimal         @db.Decimal(10, 2)
  notes         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  diagnosis     String?
  wardId        String?
  doctor        StaffMember     @relation(fields: [doctorId], references: [id])
  patient       Patient         @relation(fields: [patientId], references: [id])
  ward          Ward?           @relation(fields: [wardId], references: [id])
  dailyCharges  DailyCharge[]
  surgeries     Surgery[]

  @@map("admissions")
}

model Ward {
  id         String      @id @default(cuid())
  name       String
  wardType   WardType
  floor      String?
  capacity   Int         @default(0)
  isActive   Boolean     @default(true)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  admissions Admission[]
  beds       Bed[]
  surgeries  Surgery[]

  @@map("wards")
}

model Bed {
  id         String   @id @default(cuid())
  bedNumber  String   @unique
  wardId     String
  isOccupied Boolean  @default(false)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  ward       Ward     @relation(fields: [wardId], references: [id])

  @@map("beds")
}

model DailyCharge {
  id          String    @id @default(cuid())
  admissionId String
  serviceId   String
  amount      Decimal   @db.Decimal(10, 2)
  description String
  chargeDate  DateTime  @default(now())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  admission   Admission @relation(fields: [admissionId], references: [id])
  service     Service   @relation(fields: [serviceId], references: [id])

  @@map("daily_charges")
}

model Surgery {
  id                    String                 @id @default(cuid())
  patientId             String
  surgeonId             String
  surgeryDate           DateTime
  surgeryType           String
  operatingRoom         String?
  duration              Int?
  status                SurgeryStatus          @default(SCHEDULED)
  notes                 String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  admissionId           String?
  anesthesiaFee         Decimal                @default(0) @db.Decimal(10, 2)
  anesthesiaType        String?
  anesthesiologistId    String?
  balance               Decimal                @default(0) @db.Decimal(10, 2)
  pacuCharges           Decimal                @default(0) @db.Decimal(10, 2)
  paidAmount            Decimal                @default(0) @db.Decimal(10, 2)
  requiresInpatient     Boolean                @default(false)
  roomBookingEnd        DateTime?
  roomBookingStart      DateTime?
  roomBookingStatus     RoomBookingStatus      @default(PENDING)
  surgeryFee            Decimal                @default(0) @db.Decimal(10, 2)
  totalAmount           Decimal                @default(0) @db.Decimal(10, 2)
  wardId                String?
  operatingRoomBookings OperatingRoomBooking[]
  admission             Admission?             @relation(fields: [admissionId], references: [id])
  anesthesiologist      StaffMember?           @relation("Anesthesiologist", fields: [anesthesiologistId], references: [id])
  patient               Patient                @relation(fields: [patientId], references: [id])
  surgeon               StaffMember            @relation(fields: [surgeonId], references: [id])
  ward                  Ward?                  @relation(fields: [wardId], references: [id])
  surgicalProcedures    SurgicalProcedure[]

  @@map("surgeries")
}

model SurgicalProcedure {
  id            String   @id @default(cuid())
  surgeryId     String
  procedureName String
  description   String?
  cost          Decimal  @db.Decimal(10, 2)
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  surgery       Surgery  @relation(fields: [surgeryId], references: [id], onDelete: Cascade)

  @@map("surgical_procedures")
}

model OperatingRoomBooking {
  id          String            @id @default(cuid())
  surgeryId   String
  roomNumber  String
  bookingDate DateTime
  startTime   DateTime
  endTime     DateTime
  status      RoomBookingStatus @default(PENDING)
  notes       String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  surgery     Surgery           @relation(fields: [surgeryId], references: [id], onDelete: Cascade)

  @@map("operating_room_bookings")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  tableName String
  recordId  String
  oldValues Json?
  newValues Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

model CashTransaction {
  id              String            @id @default(cuid())
  cashierId       String
  patientId       String?
  cashRequestId   String? // Link to cash request if applicable
  transactionType TransactionType
  amount          Decimal           @db.Decimal(10, 2)
  description     String
  referenceNumber String?
  notes           String?
  status          TransactionStatus @default(COMPLETED)
  transactionDate DateTime          @default(now())
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  cashier         StaffMember       @relation(fields: [cashierId], references: [id])
  patient         Patient?          @relation(fields: [patientId], references: [id])
  cashRequest     CashRequest?      @relation(fields: [cashRequestId], references: [id])

  @@map("cash_transactions")
}

model CashRequest {
  id              String         @id @default(cuid())
  requestNumber   String         @unique // Auto-generated: CR-YYYYMMDD-001
  requesterId     String // Staff member requesting
  department      String // Department making request
  purpose         String // Reason for cash request
  amount          Decimal        @db.Decimal(10, 2)
  urgency         RequestUrgency @default(NORMAL)
  status          RequestStatus  @default(PENDING)
  approvedBy      String? // Cashier who approved
  approvedAt      DateTime?
  rejectionReason String?
  rejectedBy      String?
  rejectedAt      DateTime?
  notes           String?
  attachments     String[] // File paths/URLs
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  requester        StaffMember       @relation("CashRequestRequester", fields: [requesterId], references: [id])
  approver         StaffMember?      @relation("CashRequestApprover", fields: [approvedBy], references: [id])
  rejector         StaffMember?      @relation("CashRequestRejector", fields: [rejectedBy], references: [id])
  cashTransactions CashTransaction[] // One request can have multiple transactions

  @@map("cash_requests")
}

model PettyCash {
  id              String          @id @default(cuid())
  requesterId     String
  approverId      String?
  amount          Decimal         @db.Decimal(10, 2)
  purpose         String
  description     String?
  expectedDate    DateTime?
  notes           String?
  status          PettyCashStatus @default(PENDING)
  requestDate     DateTime        @default(now())
  approvedAt      DateTime?
  rejectedAt      DateTime?
  rejectionReason String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  approver        StaffMember?    @relation("PettyCashApprover", fields: [approverId], references: [id])
  requester       StaffMember     @relation("PettyCashRequester", fields: [requesterId], references: [id])

  @@map("petty_cash")
}

model Refund {
  id              String       @id @default(cuid())
  paymentId       String
  patientId       String
  invoiceId       String
  amount          Decimal      @db.Decimal(10, 2)
  reason          String
  notes           String?
  referenceNumber String?
  status          RefundStatus @default(PENDING)
  refundDate      DateTime     @default(now())
  approvedBy      String?
  approvedAt      DateTime?
  rejectedBy      String?
  rejectedAt      DateTime?
  rejectionReason String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  invoice         Invoice      @relation(fields: [invoiceId], references: [id])
  patient         Patient      @relation(fields: [patientId], references: [id])
  payment         Payment      @relation(fields: [paymentId], references: [id])

  @@map("refunds")
}

model PaystackCustomer {
  id                 String            @id @default(cuid())
  patientId          String            @unique
  paystackCustomerId String            @unique
  customerCode       String            @unique
  email              String
  firstName          String?
  lastName           String?
  phone              String?
  metadata           Json?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  patient            Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  paystackInvoices   PaystackInvoice[]

  @@map("paystack_customers")
}

model PaystackInvoice {
  id                 String                @id @default(cuid())
  localInvoiceId     String                @unique
  paystackCustomerId String
  paystackInvoiceId  String                @unique
  requestCode        String                @unique
  offlineReference   String?
  status             PaystackInvoiceStatus @default(PENDING)
  amount             Decimal               @db.Decimal(10, 2)
  currency           String                @default("NGN")
  description        String?
  dueDate            DateTime?
  hasInvoice         Boolean               @default(false)
  invoiceNumber      String?
  pdfUrl             String?
  lineItems          Json?
  tax                Json?
  discount           Json?
  metadata           Json?
  paidAt             DateTime?
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  localInvoice       Invoice               @relation(fields: [localInvoiceId], references: [id], onDelete: Cascade)
  paystackCustomer   PaystackCustomer      @relation(fields: [paystackCustomerId], references: [id])

  @@map("paystack_invoices")
}

enum PaystackInvoiceStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELLED
}

enum UserRole {
  ADMIN
  DOCTOR
  NURSE
  LAB_TECHNICIAN
  PHARMACIST
  CASHIER
  RECEPTIONIST
  ACCOUNTANT
  PATIENT
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum BloodType {
  A_POSITIVE
  A_NEGATIVE
  B_POSITIVE
  B_NEGATIVE
  AB_POSITIVE
  AB_NEGATIVE
  O_POSITIVE
  O_NEGATIVE
}

enum Genotype {
  AA
  AS
  AC
  SS
  SC
  CC
}

enum InvoiceStatus {
  DRAFT
  PENDING
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  MOBILE_MONEY
  INSURANCE
  CREDIT
  PAYSTACK_TERMINAL
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUND_REQUESTED
  REFUNDED
}

enum ConsultationType {
  GENERAL
  SPECIALIST
  FOLLOW_UP
  EMERGENCY
}

enum LabOrderStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum LabTestStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PrescriptionStatus {
  PENDING
  DISPENSED
  CANCELLED
}

enum AdmissionStatus {
  ADMITTED
  DISCHARGED
  TRANSFERRED
  CANCELLED
}

enum WardType {
  GENERAL
  PRIVATE
  ICU
  NURSERY
  MATERNITY
  PEDIATRIC
}

enum SurgeryStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum RoomBookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum TransactionType {
  CASH_IN
  CASH_OUT
}

enum TransactionStatus {
  PENDING
  COMPLETED
  CANCELLED
  FAILED
}

enum PettyCashStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RequestUrgency {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  COMPLETED
}
